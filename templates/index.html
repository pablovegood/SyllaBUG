<!DOCTYPE html>
<html lang="es">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <title>Comparador de Guías Docentes</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="container">

    <!-- Fila superior: logo izquierda + info derecha -->
    <div class="topbar">
      <img class="logo-ugr" src="{{ url_for('static', filename='UGR.png') }}" alt="Universidad de Granada" loading="lazy">
      <button type="button"
              class="info-btn"
              id="infoBtn"
              aria-haspopup="dialog"
              aria-controls="infoModal"
              aria-label="Información de uso">i</button>
    </div>

    <!-- Cabecera principal centrada -->
    <div class="header">
        <h1>SyllaBUG: Comparador de Guías Docentes</h1>
    </div>

    <!-- Cabecera secundaria -->
    <h2 class="subtitle">¿En qué biblioteca trabaja?</h2>

    <!-- Formulario para seleccionar biblioteca -->
    <form method="POST">
        <select name="biblioteca" required>
            {% for biblio in bibliotecas %}
                <option value="{{ biblio }}" {% if biblio == seleccion %}selected{% endif %}>{{ biblio }}</option>
            {% endfor %}
        </select>
        <button type="submit">Aceptar</button>
    </form>

    {% if mensaje %}
        <p class="mensaje">{{ mensaje }}</p>
    {% endif %}

    {% if grados is defined %}
        {% if not grados.empty %}
            <h2>Grados asociados:</h2>
            <form method="POST">
                <input type="hidden" name="biblioteca" value="{{ seleccion }}">
                <input type="hidden" name="accion" value="confirmar_grados">
                <table>
                    <thead>
                    <tr>
                        <th></th>
                        <th>Grado</th>
                        <th>Centro</th>
                        <th>CÓDIGO</th>
                        <th>URL</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for g in grados.itertuples() %}
                        {% set row = g._asdict() %}
                        <tr>
                            <td>
                                <input type="checkbox" name="grados_seleccionados" value="{{ row.get('URL','') }}">
                            </td>
                            <td>{{ row.get('Grado','') }}</td>
                            <td>{{ row.get('Centro','') }}</td>
                            <td>{{ row.get('CÓDIGO','') }}</td>
                            <td>
                                {% if row.get('URL') %}
                                    <a href="{{ row.get('URL') }}" target="_blank" rel="noopener noreferrer">Ver</a>
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                <button type="submit">Mostrar contenidos</button>
            </form>
        {% endif %}
        {# si no hay grados, no mostramos nada #}
    {% endif %}

    {% if feedback %}
        <p class="mensaje">{{ feedback }}</p>
    {% endif %}

    {% if contenido %}
        <!-- Controles de tamaño de letra para comparativas -->
        <div class="font-controls" role="group" aria-label="Controles de tamaño de letra">
          <label for="fontSizeRange">Tamaño de letra:</label>
          <input type="range" id="fontSizeRange" min="10" max="24" value="14" step="1" aria-labelledby="fontSizeRange">
          <span class="font-preview" id="fontSizeValue" aria-live="polite">14px</span>
        </div>

        <div class="contenido-comparativo" id="comparativas">
            {# El HTML de los <details> con el título "Asignatura (CODIGO)" viene ya generado por app.py #}
            {{ contenido | safe }}
        </div>
    {% endif %}
</div>

<!-- Backdrop y Modal de información -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true"></div>
<div class="modal" id="infoModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">Cómo usar esta herramienta</h2>
            <button type="button" class="modal-close" id="modalClose" aria-label="Cerrar">Cerrar</button>
        </div>
        <div class="modal-body">
            <p><strong>Nota:</strong> El programa que ven a continuación se encuentra en fase de prueba, por lo que podrían darse errores o incongruencias. Para reportar cualquier incidencia pueden comunicarse con el siguiente correo: <a href="mailto:pablog.alvarado22@gmail.com">pablog.alvarado22@gmail.com</a>.</p>

            <h3>Funcionamiento</h3>
            <ol>
                <li>Seleccione la biblioteca en la que trabaja.</li>
                <li>El programa desplegará todos los grados impartidos en la facultad en la que se encuentra la biblioteca seleccionada.</li>
                <li>Seleccione el grado o los grados de los que desee actualizar las guías docentes y haga click en “Mostrar contenidos”.</li>
                <li>Se mostrará una pestaña desplegable por cada asignatura del grado que cuente con una bibliografía.</li>
                <li>Si hace click en la pestaña desplegable de alguna asignatura, el programa mostrará una comparativa entre la guía docente del curso actual 2025-2026 y el anterior 2024-2025.</li>
            </ol>

            <h3>Qué muestran las comparativas</h3>
            <ul>
                <li>Recursos eliminados respecto al año anterior.</li>
                <li>Recursos que siguen igual.</li>
                <li>Recursos añadidos respecto al año anterior.</li>
            </ul>

            <p><strong>Importante:</strong> Debido a la diferencia de formatos entre las guías docentes del año anterior (PDF firmadas) y las actuales (HTML en la web), pueden darse errores; por favor notifíquelas al correo indicado.</p>
        </div>
    </div>
</div>

<!-- Script para abrir/cerrar el modal, control de fuente y normalización -->
<script>
(function () {
    // --- Modal ---
    const btn = document.getElementById('infoBtn');
    const modal = document.getElementById('infoModal');
    const backdrop = document.getElementById('modalBackdrop');
    const closeBtn = document.getElementById('modalClose');

    function openModal() {
        modal.setAttribute('aria-hidden', 'false');
        backdrop.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');
        closeBtn && closeBtn.focus();
    }

    function closeModal() {
        modal.setAttribute('aria-hidden', 'true');
        backdrop.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('modal-open');
        btn && btn.focus();
    }

    btn && btn.addEventListener('click', openModal);
    closeBtn && closeBtn.addEventListener('click', closeModal);
    backdrop && backdrop.addEventListener('click', closeModal);

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false') {
            closeModal();
        }
    });

    // --- Control de tamaño de fuente (con persistencia) ---
    const fontSizeRange = document.getElementById('fontSizeRange');
    const fontSizeValue = document.getElementById('fontSizeValue');
    const STORAGE_KEY = 'cmpFontSizePx';

    function applyFontSize(pxStr) {
        if (!pxStr) return;
        document.documentElement.style.setProperty('--cmp-font-size', pxStr);
        fontSizeValue && (fontSizeValue.textContent = pxStr);
        fontSizeRange && (fontSizeRange.value = parseInt(pxStr, 10));
    }

    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) applyFontSize(saved);
    } catch (e) { /* ignorar */ }

    fontSizeRange && fontSizeRange.addEventListener('input', function () {
        const size = this.value + 'px';
        document.documentElement.style.setProperty('--cmp-font-size', size);
        fontSizeValue && (fontSizeValue.textContent = size);
        try { localStorage.setItem(STORAGE_KEY, size); } catch (e) {}
    });

    // --- Normalización de saltos de línea en comparativas (preservando <a>) ---
    function normalizeTextValue(s) {
        const PRESERVE = '<<PARA_BREAK>>';
        if (!s) return s;
        let t = s.replace(/\r\n/g, '\n');     // 1) normalizar CRLF
        t = t.replace(/\n{2,}/g, PRESERVE);   // 2) preservar \n\n como separadores
        t = t.replace(/\n/g, ' ');            // 3) convertir \n simple en espacio
        t = t.replace(new RegExp(PRESERVE, 'g'), '\n\n'); // 4) restaurar separadores
        return t;
    }

    function normalizeTextNodes(root) {
        const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
            acceptNode(node) {
                if (!node.nodeValue || !node.nodeValue.match(/\S/)) return NodeFilter.FILTER_REJECT;
                return NodeFilter.FILTER_ACCEPT;
            }
        });

        const textNodes = [];
        while (walker.nextNode()) {
            // No tocar el contenido dentro de <a> para no romper enlaces
            if (walker.currentNode.parentElement && walker.currentNode.parentElement.tagName === 'A') continue;
            textNodes.push(walker.currentNode);
        }

        textNodes.forEach(n => { n.nodeValue = normalizeTextValue(n.nodeValue); });
    }

    function normalizeComparatives() {
        document.querySelectorAll('.contenido-comparativo pre').forEach(pre => {
            normalizeTextNodes(pre);
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', normalizeComparatives);
    } else {
        normalizeComparatives();
    }
})();
</script>
</body>
</html>
